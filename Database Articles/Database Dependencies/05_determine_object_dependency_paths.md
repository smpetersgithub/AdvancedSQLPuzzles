# Section 5

#### Table of Contents

1. [Introduction to SQL Server Object Dependencies](01_introduction_database_dependencies.md)
2. [Create Demo Databases and Schemas](02_create_demo_databases_and_schemas.md)
3. [Database Dependencies Examples](03_database_dependencies_examples.md)
4. [Database Dependencies Analysis](04_database_dependencies_analysis.md)
5. [Determine Object Dependency Paths](05_determine_object_dependency_paths.md)
6. [Determine Foreign Key Paths](06_determine_foreign_key_paths.md)
   
<img src="https://raw.githubusercontent.com/smpetersgithub/AdvancedSQLPuzzles/main/images/AdvancedSQLPuzzles_image.png" alt="Advanced SQL Puzzles" width="200"/>

# Determine Object Dependency Paths

[üêô The documentation and example scripts can be found in the GitHub repository.](https://github.com/smpetersgithub/AdvancedSQLPuzzles/tree/main/Database%20Articles/Database%20Dependencies/)

[üîç The script used to determine object dependency paths referenced in this section can be accessed here.](Database Articles/Database Dependencies/SQL Scripts/Additional SQL Scripts/05_Determine_Object_Dependency_Paths.sql)

-----

Next, we‚Äôll focus on determining dependency paths. 


The script generates a series of temporary stored procedures that build a list of object dependency paths based on a user-supplied database object. Because dependencies can span databases, the script is designed to trace relationships across all databases specified by the user.  The arrows in the output show the dependency path.

üîç Before running the script, please review the following concepts. Due to its length, the script is not included here‚Äîplease retrieve it from the GitHub repository.  Additional analyses related to object dependencies are provided as addendums‚Äîplease review those as well.

----

### Example Output

First, we'll review the example output generated by the script.

These examples are based on Microsoft‚Äôs publicly available `WorldWideImporters` database.

For example, here is a dependency path for the stored procedure, `WideWorldImporters.Website.SearchForPeople`.  Given the output, we can determine all objects that the stored procedure references.

üîç Objects are labeled using a four-part naming convention: `<server_name>.<schema_name>.<object_name>.<object_type>`.


----

| Path                                                                                                                  | Referenced Object Fullname                         | Depth | Object ID Path          | Type Path                           |
|-----------------------------------------------------------------------------------------------------------------------|----------------------------------------------------|-------|-------------------------|-------------------------------------|
| WideWorldImporters.Website.SearchForPeople.SQL_STORED_PROCEDURE ‚û°Ô∏è WideWorldImporters.Purchasing.Suppliers.USER_TABLE | WideWorldImporters.Purchasing.Suppliers.USER_TABLE | 1     | 910626287 ‚û°Ô∏è 610101214  | SQL_STORED_PROCEDURE ‚û°Ô∏è USER_TABLE |
| WideWorldImporters.Website.SearchForPeople.SQL_STORED_PROCEDURE ‚û°Ô∏è WideWorldImporters.Sales.Customers.USER_TABLE      | WideWorldImporters.Sales.Customers.USER_TABLE      | 1     | 910626287 ‚û°Ô∏è 802101898  | SQL_STORED_PROCEDURE ‚û°Ô∏è USER_TABLE |
| WideWorldImporters.Website.SearchForPeople.SQL_STORED_PROCEDURE ‚û°Ô∏è WideWorldImporters.Application.People.USER_TABLE   | WideWorldImporters.Application.People.USER_TABLE   | 1     | 910626287 ‚û°Ô∏è 1301579675 | SQL_STORED_PROCEDURE ‚û°Ô∏è USER_TABLE |



----

We can also determine reverse dependencies.  In this example, we identify all objects that depend on the `WideWorldImporters.Sales.Customers` table.


| Path                                                                                                                                                                                           | Referenced Object Fullname                                                         | Depth | Object ID Path                       | Type Path                                                |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------|-------|--------------------------------------|----------------------------------------------------------|
| WideWorldImporters.Application.FilterCustomersBySalesTerritoryRole.SECURITY_POLICY ‚¨ÖÔ∏è WideWorldImporters.Sales.Customers.USER_TABLE                                                            | WideWorldImporters.Application.FilterCustomersBySalesTerritoryRole.SECURITY_POLICY | 1     | 784721848 ‚¨ÖÔ∏è 802101898               | SECURITY_POLICY ‚¨ÖÔ∏è USER_TABLE                             |
| WideWorldImporters.Integration.GetCustomerUpdates.SQL_STORED_PROCEDURE ‚¨ÖÔ∏è WideWorldImporters.Sales.Customers.USER_TABLE                                                                        | WideWorldImporters.Integration.GetCustomerUpdates.SQL_STORED_PROCEDURE             | 1     | 1774629365 ‚¨ÖÔ∏è 802101898              | SQL_STORED_PROCEDURE ‚¨ÖÔ∏è USER_TABLE                        |
| WideWorldImporters.Integration.GetOrderUpdates.SQL_STORED_PROCEDURE ‚¨ÖÔ∏è WideWorldImporters.Sales.Customers.USER_TABLE                                                                           | WideWorldImporters.Integration.GetOrderUpdates.SQL_STORED_PROCEDURE                | 1     | 1886629764 ‚¨ÖÔ∏è 802101898              | SQL_STORED_PROCEDURE ‚¨ÖÔ∏è USER_TABLE                        |
| WideWorldImporters.Integration.GetSaleUpdates.SQL_STORED_PROCEDURE ‚¨ÖÔ∏è WideWorldImporters.Sales.Customers.USER_TABLE                                                                            | WideWorldImporters.Integration.GetSaleUpdates.SQL_STORED_PROCEDURE                 | 1     | 1918629878 ‚¨ÖÔ∏è 802101898              | SQL_STORED_PROCEDURE ‚¨ÖÔ∏è USER_TABLE                        |
| WideWorldImporters.Website.CalculateCustomerPrice.SQL_SCALAR_FUNCTION ‚¨ÖÔ∏è WideWorldImporters.Sales.Customers.USER_TABLE                                                                         | WideWorldImporters.Website.CalculateCustomerPrice.SQL_SCALAR_FUNCTION              | 1     | 1310627712 ‚¨ÖÔ∏è 802101898              | SQL_SCALAR_FUNCTION ‚¨ÖÔ∏è USER_TABLE                         |
| WideWorldImporters.Website.Customers.VIEW ‚¨ÖÔ∏è WideWorldImporters.Sales.Customers.USER_TABLE                                                                                                     | WideWorldImporters.Website.Customers.VIEW                                          | 1     | 1694629080 ‚¨ÖÔ∏è 802101898              | VIEW ‚¨ÖÔ∏è USER_TABLE                                        |
| WideWorldImporters.Website.InsertCustomerOrders.SQL_STORED_PROCEDURE ‚¨ÖÔ∏è WideWorldImporters.Website.CalculateCustomerPrice.SQL_SCALAR_FUNCTION ‚¨ÖÔ∏è WideWorldImporters.Sales.Customers.USER_TABLE | WideWorldImporters.Website.InsertCustomerOrders.SQL_STORED_PROCEDURE               | 2     | 2004202190 ‚¨ÖÔ∏è 1310627712 ‚¨ÖÔ∏è 802101898 | SQL_STORED_PROCEDURE ‚¨ÖÔ∏è SQL_SCALAR_FUNCTION ‚¨ÖÔ∏è USER_TABLE |
| WideWorldImporters.Website.InvoiceCustomerOrders.SQL_STORED_PROCEDURE ‚¨ÖÔ∏è WideWorldImporters.Sales.Customers.USER_TABLE                                                                         | WideWorldImporters.Website.InvoiceCustomerOrders.SQL_STORED_PROCEDURE              | 1     | 1972202076 ‚¨ÖÔ∏è 802101898              | SQL_STORED_PROCEDURE ‚¨ÖÔ∏è USER_TABLE                        |
| WideWorldImporters.Website.SearchForCustomers.SQL_STORED_PROCEDURE ‚¨ÖÔ∏è WideWorldImporters.Sales.Customers.USER_TABLE                                                                            | WideWorldImporters.Website.SearchForCustomers.SQL_STORED_PROCEDURE                 | 1     | 942626401 ‚¨ÖÔ∏è 802101898               | SQL_STORED_PROCEDURE ‚¨ÖÔ∏è USER_TABLE                        |
| WideWorldImporters.Website.SearchForPeople.SQL_STORED_PROCEDURE ‚¨ÖÔ∏è WideWorldImporters.Sales.Customers.USER_TABLE                                                                               | WideWorldImporters.Website.SearchForPeople.SQL_STORED_PROCEDURE                    | 1     | 910626287 ‚¨ÖÔ∏è 802101898               | SQL_STORED_PROCEDURE ‚¨ÖÔ∏è USER_TABLE                        |


----

### Key Details Before Running the Script

Next, I want to highlight a few key details before we execute the script.

1. **Cross-Database Dependencies**    
     * The script can trace dependencies across multiple databases (*Example 01*). Pass the list of databases as parameters to capture the full dependency paths.

2. **Unknown Dependencies**    
     * Object aliases (*Example 11*) and invalid objects (*Example 03 and Example 08*) will show as UNKNOWN objects.

3. **Self-Referencing Objects**    
     * Self-referencing objects (*Example 10*) are removed to prevent infinite loops.
       
4. **Synonyms**
     * Synonyms (*Example 13*) are listed as root nodes. The table `sys.sql_expression_dependencies` records dependencies on the synonym, but not on the object it references.

4. **Caller Dependent**
     * Caller‚Äëdependent procedures (*Example 07*) are assumed to reside in the `dbo` schema, and their `referenced_id` is determined by their object name.

-----

### Temporary Stored Procedures Created

The script generates the following global temporary stored procedures. I‚Äôve modularized the logic to improve readability and maintainability.

The procedure `##temp_sp_update_sql_expression_dependencies` centralizes the rules that populate `##sys_sql_expression_dependencies` to build object‚Äëdependency paths.

```text
##temp_sp_create_tables
##temp_sp_insert_sql_statement
##temp_sp_cursor_insert_sql_expression_dependencies
##temp_sp_cursor_insert_sys_objects
##temp_sp_update_sql_expression_dependencies
##temp_sp_determine_paths
##temp_sp_determine_reverse_paths

--The following are master executions which reference the above stored procedures

##temp_sp_master_execution_paths
##temp_sp_master_execution_reverse_paths
```

‚ö†Ô∏è Although these are global temporary procedures, they must be executed within the same session in which they are created. Running them in a new session will result in an error (*"String or binary data would be truncated..."*)

---

### Usage Notes

To execute the temporary stored procedures, first run the script to create them, then call the temporary procedures within the same session.

The temporary stored procedures do not need to be created in the same schema as the object you're analyzing. You will specify the databases to trace dependencies across, passing the databases as a parameter. It's common to run this script from the `master` database.

When calling stored procedures, note the below usage where three-part naming convention is used for the object name, and a comma seperated list can be used to pass multiple databases.

‚ö†Ô∏è I‚Äôve implemented all the recommended indexes as suggested in the execution plan; however, depending on the query patterns and data distribution, the current indexing strategy may still require adjustments. You may want to review and optimize the indexes further.

### Example Execution

üîç  The following example demonstrates how to trace dependency paths within a single database where the object resides.

```sql
-- Use the following to execute the stored procedures

-- Forward dependencies
EXECUTE ##temp_sp_master_execution_paths 'WideWorldImporters.Website.SearchForPeople';
GO

-- Reverse dependencies
EXECUTE ##temp_sp_master_execution_reverse_paths 'WideWorldImporters.Sales.Customers';
GO
```

---

üîç  The following example demonstrates how to trace dependency paths across multiple databases.

When passing the list of databases, ensure proper formatting so the dynamic SQL can parse the values correctly!

```sql
-- Use the following to execute the stored procedures

-- Forward dependencies
EXECUTE ##temp_sp_master_execution_paths 'WideWorldImporters.Website.SearchForPeople', 'WideWorldImporters,AdventureWorks';
GO

-- Reverse dependencies
EXECUTE ##temp_sp_master_execution_reverse_paths 'WideWorldImporters.Sales.Customers', 'WideWorldImporters,AdventureWorks';
GO
```

### Selecting a Dependency Path Procedure

Use one of the following stored procedures based on the direction of analysis. You‚Äôll need to pass the target object using a three-part naming convention as a parameter:

* `##temp_sp_master_execution_paths` ‚Äì Traces downstream dependencies (what the object depends on)
* `##temp_sp_master_execution_reverse_paths` ‚Äì Traces upstream dependencies (what depends on the object)

---

[üîç The script used to determine object dependency paths referenced in this section can be accessed here.](https://...)


