#### Table of Contents

1. [Introduction to SQL Server Object Dependencies](01_introduction_database_dependencies.md)
2. [Create Demo Databases and Schemas](02_create_demo_databases_and_schemas.md)
3. [Database Dependency Examples](03_database_dependencies_examples.md)
4. [Analyze Database Dependencies](04_analyze_database_dependencies.md)
5. [Determine Object Dependency Paths](05_determine_object_dependency_paths.md)
6. [Determine Foreign Key Paths](06_determine_foreign_key_paths.md)

<img src="https://raw.githubusercontent.com/smpetersgithub/AdvancedSQLPuzzles/main/images/AdvancedSQLPuzzles_image.png" alt="Advanced SQL Puzzles" width="200"/>

# Foreign Key Dependency Path Analysis

[üìÑ The corresponding scripts for this walkthrough are available here.](https://github.com/smpetersgithub/AdvancedSQLPuzzles/tree/main/Database%20Articles/Database%20Dependencies/)

Next, we‚Äôll focus on determining foreign key paths. This is similar to determining object dependency paths, but here we focus exclusively on foreign key dependencies. A script provided at the end of this chapter automates this process.

Foreign key dependencies can be viewed via the system views `sys.foregn_keys` and `sys.foreign_key_columns` system views.  Foreign Key dependencies are not part of the `sys.sql_Expression_dependencies` table.

Foreign keys cannot be created across databases, so unlike object dependency paths, we do not need to account for cross-database foreign keys.  Before you run the script, you will need to modify the `USE` statement to use the correct database.

Before running the script, we will cover a few key concepts.

----

### Example Output

First, we‚Äôll review the example output generated by the script.

These examples are based on Microsoft‚Äôs publicly available `WorldWideImporters` database.

The following illustrates a foreign key path for the `Orders` table. From this output, we can identify all objects that the table depends on via foreign keys, as well as the dependencies of those related tables.

üîç Objects are labeled using a three-part naming convention: `<server_name>.<schema>.<object_name>`

----

| ID | Table Name                      | Path                                                                     | Depth |
|----|---------------------------------|--------------------------------------------------------------------------|-------|
| 1  | Sales.Orders                    | Sales.Orders                                                             | 0     |
| 2  | Application.People              | Sales.Orders  ‚û°Ô∏è  Application.People                                    | 1     |
| 3  | Application.Cities              | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Application.Cities              | 2     |
| 4  | Application.Countries           | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Application.Countries           | 2     |
| 5  | Application.DeliveryMethods     | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Application.DeliveryMethods     | 2     |
| 6  | Application.PaymentMethods      | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Application.PaymentMethods      | 2     |
| 7  | Application.StateProvinces      | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Application.StateProvinces      | 2     |
| 8  | Application.SystemParameters    | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Application.SystemParameters    | 2     |
| 9  | Application.TransactionTypes    | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Application.TransactionTypes    | 2     |
| 10 | Purchasing.PurchaseOrderLines   | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Purchasing.PurchaseOrderLines   | 2     |
| 11 | Purchasing.PurchaseOrders       | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Purchasing.PurchaseOrders       | 2     |
| 12 | Purchasing.SupplierCategories   | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Purchasing.SupplierCategories   | 2     |
| 13 | Purchasing.Suppliers            | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Purchasing.Suppliers            | 2     |
| 14 | Purchasing.SupplierTransactions | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Purchasing.SupplierTransactions | 2     |
| 15 | Sales.BuyingGroups              | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Sales.BuyingGroups              | 2     |
| 16 | Sales.CustomerCategories        | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Sales.CustomerCategories        | 2     |
| 17 | Sales.CustomerTransactions      | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Sales.CustomerTransactions      | 2     |
| 18 | Sales.InvoiceLines              | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Sales.InvoiceLines              | 2     |
| 19 | Sales.SpecialDeals              | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Sales.SpecialDeals              | 2     |
| 20 | Warehouse.Colors                | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Warehouse.Colors                | 2     |
| 21 | Warehouse.PackageTypes          | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Warehouse.PackageTypes          | 2     |
| 22 | Warehouse.StockGroups           | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Warehouse.StockGroups           | 2     |
| 23 | Warehouse.StockItemHoldings     | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Warehouse.StockItemHoldings     | 2     |
| 24 | Warehouse.StockItems            | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Warehouse.StockItems            | 2     |
| 25 | Warehouse.StockItemStockGroups  | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Warehouse.StockItemStockGroups  | 2     |
| 26 | Warehouse.StockItemTransactions | Sales.Orders  ‚û°Ô∏è  Application.People ‚û°Ô∏è Warehouse.StockItemTransactions | 2     |
| 27 | Sales.Customers                 | Sales.Orders  ‚û°Ô∏è  Sales.Customers                                       | 1     |
| 28 | Sales.Invoices                  | Sales.Orders ‚û°Ô∏è Sales.Invoices                                          | 1     |
| 29 | Sales.OrderLines                | Sales.Orders ‚û°Ô∏è Sales.OrderLines                                        | 1     |

----

We can also determine reverse dependencies.  In this example, we identify all objects that have a foreign key path to the `Orders` table.

| ID | TableName                       | Path                                                               | Depth |
|----|---------------------------------|--------------------------------------------------------------------|-------|
| 1  | Sales.Orders                    | Sales.Orders                                                       | 0     |
| 2  | Sales.Invoices                  | Sales.Invoices ‚¨ÖÔ∏è Sales.Orders                                     | 1    |
| 3  | Sales.OrderLines                | Sales.OrderLines ‚¨ÖÔ∏è Sales.Orders                                   | 1    |
| 4  | Sales.CustomerTransactions      | Sales.CustomerTransactions ‚¨ÖÔ∏è Sales.Invoices ‚¨ÖÔ∏è Sales.Orders      | 2     |
| 5  | Sales.InvoiceLines              | Sales.InvoiceLines ‚¨ÖÔ∏è Sales.Invoices ‚¨ÖÔ∏è Sales.Orders              | 2     |
| 6  | Warehouse.StockItemTransactions | Warehouse.StockItemTransactions ‚¨ÖÔ∏è Sales.Invoices ‚¨ÖÔ∏è Sales.Orders | 2     |

----

### Temporary Stored Procedures Created

The script creates the following global temporary stored procedures. I‚Äôve modularized the logic to improve readability and maintainability.

While I won‚Äôt go into the implementation details here, you can paste the code into a large language model (LLM) to get a high-level summary of each procedure‚Äôs functionality.

```text
##temp_create_tables
##temp_sp_determine_fk_paths;
##temp_sp_determine_fk_paths_reverse;
```
---

### Usage Notes

To execute the temporary stored procedures, first run the script to create them, and then execute the procedures.

For this example, we are using the `WideWorldImports` database on the `Orders` table.  You‚Äôll need to update the script‚Äôs `USE` statement to point to the correct database.

The `##Table_Foreign_Keys_Map` table is available if you need details about the columns involved in each foreign key relationship.

#### Example Execution

```sql
EXECUTE ##temp_create_tables;
EXECUTE ##temp_sp_determine_fk_paths 'dbo.Orders';
EXECUTE ##temp_sp_determine_fk_paths_reverse 'dbo.Orders';


--View the FK mappings
SELECT * FROM ##Table_Foreign_Keys_Map;
```

#### Selecting a Dependency Path Procedure

Use one of the following stored procedures based on the direction of analysis. You‚Äôll need to pass the target object as a parameter:

* `##temp_sp_determine_fk_paths` ‚Äì Traces downstream foreign key dependencies (what the object depends on)
* `##temp_sp_determine_fk_paths_reverse` ‚Äì Traces upstream foreign key dependencies (what depends on the object)

---

#### Current Limitations

These limitations are planned to be addressed in future versions of the script:

1. Single Table Dependency Resolution

    *  The script currently resolves foreign key dependencies for one table at a time. It does not generate dependency chains for all tables in a database. This design is intentional, as processing the full dependency map for an entire database can be computationally intensive.

---

### SQL Script

And now, without further ado, here is the script to generate foreign key dependency paths.  This script is also located in the GitHub repository.

```sql
USE WideWorldImporters;
GO

/*

üìã Instructions

Please visit the following URL for instructions.

https://github.com/smpetersgithub/AdvancedSQLPuzzles/tree/main/Database%20Articles/Database%20Dependencies

1. Update the USE statement for the correct database
2. Create the temporary stored procedures
3. Execute the stored procedures

--------------------------------------------------------
--------------------------------------------------------

Please use the following to execute the stored procedures.

EXECUTE ##temp_create_tables;
GO
EXECUTE ##temp_sp_determine_fk_paths 'Sales.Orders';
GO
EXECUTE ##temp_sp_determine_fk_paths_reverse 'Sales.Orders';
GO

--View the FK mappings
SELECT * FROM ##table_foreign_keys_map;

*/

CREATE OR ALTER PROCEDURE ##temp_create_tables 
AS
BEGIN
    DROP TABLE IF EXISTS ##fk_paths;
    CREATE TABLE ##fk_paths
    (
        table_id   INTEGER,
        table_name SYSNAME,
        [path]     NVARCHAR(MAX),
        depth     INT,
        processed BIT DEFAULT 0
    );
    
    DROP TABLE IF EXISTS ##table_foreign_keys_map;
    SELECT  
        fk.[name] AS foreign_key_name,
        tp.[object_id] AS parent_table_id,
        s_tp.[name] AS parent_schema,
        CONCAT_WS('.', s_tp.[name], tp.[name]) AS parent_table,
        cp.[name] AS parent_column,
        refp.[object_id] AS referenced_table_id,
        s_ref.[name] AS referenced_schema,
        CONCAT_WS('.', s_ref.[name], refp.[name]) AS referenced_table,
        cref.[name] AS referenced_column
    INTO ##table_foreign_keys_map
    FROM sys.foreign_keys fk
    INNER JOIN sys.foreign_key_columns fkc 
        ON fkc.constraint_object_id = fk.[object_id]
    INNER JOIN sys.tables tp 
        ON fkc.parent_object_id = tp.[object_id]
    INNER JOIN sys.schemas s_tp 
        ON tp.schema_id = s_tp.schema_id
    INNER JOIN sys.columns cp 
        ON fkc.parent_object_id = cp.[object_id] 
       AND fkc.parent_column_id = cp.column_id
    INNER JOIN sys.tables refp 
        ON fkc.referenced_object_id = refp.[object_id]
    INNER JOIN sys.schemas s_ref 
        ON refp.schema_id = s_ref.schema_id
    INNER JOIN sys.columns cref 
        ON fkc.referenced_object_id = cref.[object_id] 
       AND fkc.referenced_column_id = cref.column_id;
END;
GO

CREATE OR ALTER PROCEDURE ##temp_sp_determine_fk_paths (@v_object_name VARCHAR(1000)) AS
BEGIN
    DECLARE @max_iterations INT = 100;
    DECLARE @iteration INT = 0;

    -- Seed with starting table
    INSERT INTO ##fk_paths (table_id, table_name, [path], depth, processed)
    SELECT 
        t.object_id, 
        s.[name] + '.' + t.[name],
        s.[name] + '.' + t.[name],
        0, 
        0
    FROM sys.tables t
    INNER JOIN sys.schemas s ON t.schema_id = s.schema_id
    WHERE s.[name] + '.' + t.[name] = @v_object_name;

    -- Loop until no more unprocessed or max iteration
    WHILE EXISTS (SELECT 1 FROM ##fk_paths WHERE processed = 0) AND @iteration < @max_iterations
    BEGIN
        SET @iteration += 1;

        DECLARE @current_table_id INT, @current_path NVARCHAR(MAX), @current_depth INT;
        SELECT TOP (1)
            @current_table_id = table_id,
            @current_path = [path],
            @current_depth = depth
        FROM ##fk_paths
        WHERE processed = 0
        ORDER BY depth;

        -- From parent -> child (referenced table)
        INSERT INTO ##fk_paths (table_id, table_name, [path], depth, processed)
        SELECT fk.referenced_table_id, fk.referenced_table,
               @current_path + N'  ‚û°Ô∏è  ' + fk.referenced_table,
               @current_depth + 1, 0
        FROM ##table_foreign_keys_map fk
        WHERE fk.parent_table_id = @current_table_id
          AND NOT EXISTS (
              SELECT 1 FROM ##fk_paths 
              WHERE table_id = fk.referenced_table_id 
              AND [path] COLLATE DATABASE_DEFAULT LIKE '%' + fk.referenced_table COLLATE DATABASE_DEFAULT + '%'
          );

        -- From child -> parent (parent table)
        INSERT INTO ##fk_paths (table_id, table_name, [path], depth, processed)
        SELECT fk.parent_table_id, fk.parent_table,
               @current_path + N' ‚û°Ô∏è ' + fk.parent_table,
               @current_depth + 1, 0
        FROM ##table_foreign_keys_map fk
        WHERE fk.referenced_table_id = @current_table_id
          AND NOT EXISTS (
              SELECT 1 FROM ##fk_paths 
              WHERE table_id = fk.parent_table_id 
              AND [path] COLLATE DATABASE_DEFAULT LIKE '%' + fk.parent_table COLLATE DATABASE_DEFAULT + '%'
          );

        -- Mark processed
        UPDATE ##fk_paths
        SET processed = 1
        WHERE table_id = @current_table_id AND [path] = @current_path;
    END;

    -- Final results
    SELECT DISTINCT @@SERVERNAME AS server_name, table_name, [path], depth
    FROM ##fk_paths
    ORDER BY [path], depth;
END;
GO

CREATE OR ALTER PROCEDURE ##temp_sp_determine_fk_paths_reverse (@v_object_name SYSNAME) AS
BEGIN
    DECLARE @max_iterations INT = 100;
    DECLARE @iteration INT = 0;

    IF OBJECT_ID('tempdb..##fk_paths') IS NOT NULL
        DELETE FROM ##fk_paths;

    -- Seed with starting table
    INSERT INTO ##fk_paths (table_id, table_name, [path], depth, processed)
    SELECT 
        t.object_id, 
        s.[name] + '.' + t.[name],
        s.[name] + '.' + t.[name],
        0, 
        0
    FROM sys.tables t
    INNER JOIN sys.schemas s ON t.schema_id = s.schema_id
    WHERE s.[name] + '.' + t.[name] = @v_object_name;

    -- Loop until no more unprocessed or max iteration
    WHILE EXISTS (SELECT 1 FROM ##fk_paths WHERE processed = 0) AND @iteration < @max_iterations
    BEGIN
        SET @iteration += 1;

        DECLARE @current_table_id INT, @current_path NVARCHAR(MAX), @current_depth INT;
        SELECT TOP (1)
            @current_table_id = table_id,
            @current_path = [path],
            @current_depth = depth
        FROM ##fk_paths
        WHERE processed = 0
        ORDER BY depth;

        -- From child ‚Üí parent
        INSERT INTO ##fk_paths (table_id, table_name, [path], depth, processed)
        SELECT fk.parent_table_id, fk.parent_table,
               fk.parent_table + N' ‚¨ÖÔ∏è ' + @current_path,
               @current_depth + 1, 0
        FROM ##table_foreign_keys_map fk
        WHERE fk.referenced_table_id = @current_table_id
          AND NOT EXISTS (
              SELECT 1 FROM ##fk_paths 
              WHERE table_id = fk.parent_table_id 
              AND [path] COLLATE DATABASE_DEFAULT LIKE '%' + fk.parent_table COLLATE DATABASE_DEFAULT + '%'
          );

        -- Mark as processed
        UPDATE ##fk_paths
        SET processed = 1
        WHERE table_id = @current_table_id AND [path] = @current_path;
    END;

    -- Final results
    SELECT DISTINCT @@SERVERNAME AS ServerName, table_name, [path], depth
    FROM ##fk_paths
    ORDER BY depth, [path];
END;
GO
```
