# Section 6

#### Table of Contents

1. [Introduction to SQL Server Object Dependencies](01_introduction_database_dependencies.md)
2. [Create Demo Databases and Schemas](02_create_demo_databases_and_schemas.md)
3. [Database Dependencies Examples](03_database_dependencies_examples.md)
4. [Database Dependencies Analysis](04_database_dependencies_analysis.md)
5. [Determine Object Dependency Paths](05_determine_object_dependency_paths.md)
6. [Determine Foreign Key Paths](06_determine_foreign_key_paths.md)

<img src="https://raw.githubusercontent.com/smpetersgithub/AdvancedSQLPuzzles/main/images/AdvancedSQLPuzzles_image.png" alt="Advanced SQL Puzzles" width="200"/>

# Determine Foreign Key Paths

[üêô The documentation and example scripts can be found in the GitHub repository.](https://github.com/smpetersgithub/AdvancedSQLPuzzles/tree/main/Database%20Articles/Database%20Dependencies/)

[üîç The script used to determine foreign key paths referenced in this section can be accessed here.](https://github.com/smpetersgithub/AdvancedSQLPuzzles/blob/main/Database%20Articles/Database%20Dependencies/SQL%20Scripts/Additional%20SQL%20Scripts/06_Determine_Foreign_Key_Paths.sql)

-----

Next, we‚Äôll focus on determining foreign key paths. This is similar to determining object dependency paths, but here we focus exclusively on foreign key dependencies.

Foreign key dependencies can be viewed via the system views `sys.foregn_keys` and `sys.foreign_key_columns`.  Foreign Key dependencies are not part of the `sys.sql_Expression_dependencies` table.

Also, foreign keys cannot be created across databases, so unlike object dependency paths, we do not need to account for cross-database foreign keys.  Before you run the script, you will need to modify the `USE` statement to use the correct database.

üîç Before running the script, please review the following concepts. Due to its length, the script is not included here‚Äîplease retrieve it from the GitHub repository.  Additional analyses related to object dependencies are provided as addendums‚Äîplease review those as well.

----

### Example Output

First, we‚Äôll review the example output generated by the script.

These examples are based on Microsoft‚Äôs publicly available `WorldWideImporters` database.

The following illustrates a foreign key path for the `Sales.Orders` table. From this output, we can identify all objects that the table depends on via foreign keys, as well as the dependencies of those related tables.

üîç Objects are labeled using a three-part naming convention: `<server_name>.<schema_name>.<object_name>`

----

| Table Name                          | Path                                                                   | Depth | Object ID Path                          |
|-------------------------------------|------------------------------------------------------------------------|-------|-----------------------------------------|
| Sales.Orders                        | Sales.Orders                                                           | 0     | 1154103152                              |
| Application.People                  | Sales.Orders ‚û°Ô∏è Application.People                                     | 1     | 1154103152 ‚û°Ô∏è 1301579675               |
| Application.Cities                  | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Application.Cities               | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 402100473  |
| Application.Countries               | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Application.Countries            | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 1461580245 |
| Application.DeliveryMethods         | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Application.DeliveryMethods      | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 1573580644 |
| Application.PaymentMethods          | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Application.PaymentMethods       | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 1669580986 |
| Application.StateProvinces          | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Application.StateProvinces       | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 290100074  |
| Application.SystemParameters        | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Application.SystemParameters     | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 498100815  |
| Application.TransactionTypes        | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Application.TransactionTypes     | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 1765581328 |
| Purchasing.PurchaseOrderLines       | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Purchasing.PurchaseOrderLines    | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 1554104577 |
| Purchasing.PurchaseOrders           | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Purchasing.PurchaseOrders        | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 1026102696 |
| Purchasing.SupplierCategories       | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Purchasing.SupplierCategories    | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 1861581670 |
| Purchasing.Suppliers                | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Purchasing.Suppliers             | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 610101214  |
| Purchasing.SupplierTransactions     | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Purchasing.SupplierTransactions  | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 1682105033 |
| Sales.BuyingGroups                  | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Sales.BuyingGroups               | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 1957582012 |
| Sales.CustomerCategories            | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Sales.CustomerCategories         | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 2053582354 |
| Sales.CustomerTransactions          | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Sales.CustomerTransactions       | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 366624349  |
| Sales.InvoiceLines                  | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Sales.InvoiceLines               | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 510624862  |
| Sales.SpecialDeals                  | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Sales.SpecialDeals               | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 1826105546 |
| Warehouse.Colors                    | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Warehouse.Colors                 | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 2099048    |
| Warehouse.PackageTypes              | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Warehouse.PackageTypes           | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 98099390   |
| Warehouse.StockGroups               | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Warehouse.StockGroups            | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 194099732  |
| Warehouse.StockItemHoldings         | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Warehouse.StockItemHoldings      | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 1474104292 |
| Warehouse.StockItems                | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Warehouse.StockItems             | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 1314103722 |
| Warehouse.StockItemStockGroups      | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Warehouse.StockItemStockGroups   | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 222623836  |
| Warehouse.StockItemTransactions     | Sales.Orders ‚û°Ô∏è Application.People ‚û°Ô∏è Warehouse.StockItemTransactions  | 2     | 1154103152 ‚û°Ô∏è 1301579675 ‚û°Ô∏è 638625318  |
| Sales.Customers                     | Sales.Orders ‚û°Ô∏è Sales.Customers                                        | 1     | 1154103152 ‚û°Ô∏è 802101898                 |
| Sales.Invoices                      | Sales.Orders ‚û°Ô∏è Sales.Invoices                                         | 1     | 1154103152 ‚û°Ô∏è 2018106230                |
| Sales.OrderLines                    | Sales.Orders ‚û°Ô∏è Sales.OrderLines                                       | 1     | 1154103152 ‚û°Ô∏è 94623380                  |


----

We can also determine reverse dependencies.  In this example, we identify all objects that have a foreign key path to the `Sales.Orders` table.

| Table Name                      | Path                                                              | Depth | Object ID Path                       |
|---------------------------------|-------------------------------------------------------------------|-------|--------------------------------------|
| Sales.Orders                    | Sales.Orders                                                      | 0     | 1154103152                           |
| Sales.Invoices                  | Sales.Invoices ‚¨ÖÔ∏è Sales.Orders                                    | 1     | 2018106230 ‚¨ÖÔ∏è 1154103152              |
| Sales.OrderLines                | Sales.OrderLines ‚¨ÖÔ∏è Sales.Orders                                  | 1     | 94623380 ‚¨ÖÔ∏è 1154103152                |
| Sales.CustomerTransactions      | Sales.CustomerTransactions ‚¨ÖÔ∏è Sales.Invoices ‚¨ÖÔ∏è Sales.Orders      | 2     | 366624349 ‚¨ÖÔ∏è 2018106230 ‚¨ÖÔ∏è 1154103152 |
| Sales.InvoiceLines              | Sales.InvoiceLines ‚¨ÖÔ∏è Sales.Invoices ‚¨ÖÔ∏è Sales.Orders              | 2     | 510624862 ‚¨ÖÔ∏è 2018106230 ‚¨ÖÔ∏è 1154103152 |
| Warehouse.StockItemTransactions | Warehouse.StockItemTransactions ‚¨ÖÔ∏è Sales.Invoices ‚¨ÖÔ∏è Sales.Orders | 2     | 638625318 ‚¨ÖÔ∏è 2018106230 ‚¨ÖÔ∏è 1154103152 |

----

### Temporary Stored Procedures Created

The script generates the following global temporary stored procedures. I‚Äôve modularized the logic to improve readability and maintainability.

```text
##temp_create_tables
##temp_sp_determine_foreign_key_paths
##temp_sp_determine_foreign_key_paths_reverse

--The following are master executions which reference the above stored procedures

##temp_sp_master_execution_foreign_key_paths
##temp_sp_master_execution_foreign_key_reverse_paths
```

---

### Usage Notes

To execute the temporary stored procedures, first run the script to create them, then execute the temporary stored procedures.

For this example, we are using the `WideWorldImports` database on the `Sales.Orders` table.  You‚Äôll need to update the script‚Äôs `USE` statement to point to the correct database.

The `##foreign_keys_map` table is available if you need details about the columns involved in each foreign key relationship.

‚ö†Ô∏è During testing, no missing index recommendations were generated and performance was not an issue. However, if performance issues do arise, you may want to consider applying a custom indexing strategy.

#### Example Execution

```sql
-- Use the following to execute the stored procedures

EXECUTE ##temp_sp_master_execution_fk_paths 'Sales.Orders'
EXECUTE ##temp_sp_master_execution_fk_reverse_paths 'Sales.Orders'

-- Use the following to view the foreign key mappings

SELECT * FROM ##table_foreign_keys_map;
```

#### Selecting a Dependency Path Procedure

Use one of the following stored procedures based on the direction of analysis. You‚Äôll need to pass the target object as a parameter:

* `##temp_sp_master_execution_fk_paths` ‚Äì Traces downstream foreign key dependencies (what the object depends on)
* `##temp_sp_master_execution_fk_reverse_paths` ‚Äì Traces upstream foreign key dependencies (what depends on the object)

---

